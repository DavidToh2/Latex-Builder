# Introduction

This file documents how authentication is implemented.

- [Introduction](#introduction)
- [Authentication and Login Systems](#authentication-and-login-systems)
	- [Session Store](#session-store)
	- [Logging In](#logging-in)
	- [Authentication Check (Backend)](#authentication-check-backend)
- [Email Verification (TBA)](#email-verification-tba)


# Authentication and Login Systems

We use `express-session`, built-in middleware that implements a session management system, using a **Store**. We use `connect-mongo` for the SessionStore, which will be attached to our main database.

JSON Web Tokens (JWTs) are a more modern form of session authentication that are arguably more secure, as the tokens are not stored on the server (i.e. are stateless) and can be encrypted and decrypted by the server as necessary.

## Session Store

The following cookies will be stored in the user's session storage:
```
Session ID: [generated by express-session]
User ID: [sent by server upon successful login]
```

Session data is stored in the server's SessionStore in this format. The session ID is hashed using the secret in our `.env` folder.
```
{ Encrypted Session ID, { Attached Session Data } }
```

The SessionStore is set up in `app.js`.

## Logging In

Sessions are first initialised on login. The session token is regenerated, creating a new session token, and the user ID is directly stored in the session data.

```js
const nU = await authenticateUser(userData)
if (nU) {
	response.status = 0
	req.session.regenerate((err) => {if(err) next(err)})
	req.session.uID = nU['id']
}
```

Other user data, such as username and social info, are directly sent back via the response to be stored in the local UserStore. For more information, refer to the frontend documentation.

## Authentication Check (Backend)

We can access the SessionStore simply by invoking `req.session`. This will fetch our current user's session ID (stored in the user's session data), check it against our SessionStore, then (if present) fetch all other session data.

This allows us to authenticate users simply by checking the SessionStore for session data (i.e. `req.session.uID`) corresponding to their current session ID.
```js
db-auth.js:
function isAuthenticated() {
	if (req.session.uID) next()
	else next('route')		// skips to the next route definition
}
```

Routers can use this function as a callback:
```js
router.post(route1, isAuthenticated, <function to execute if authenticated>){}
router.post(route1, <function to execute if unauthenticated>){}
```

[Documentation for `express-session`](https://www.npmjs.com/package/express-session?activeTab=readme)

[Documentation for `connect-mongo`](https://www.npmjs.com/package/connect-mongo)

[How session tokens and session validation work (StackExchange)](https://security.stackexchange.com/questions/255762/is-this-a-right-technique-to-create-and-validate-session-tokens)

[Express session middleware](https://stackoverflow.com/questions/73049959/express-session-middleware-to-check-authentication)

[Using `express-session` and MongoDB to manage sessions](https://developer.okta.com/blog/2021/06/07/session-mgmt-node)

# Email Verification (TBA)